<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Custos de Empréstimo - PORTUS (Corrigido)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .tab-button.active {
            border-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            text-align: right;
        }
        th {
            background-color: #f1f5f9;
            font-weight: 600;
            text-align: center;
        }
        tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Estrutura de Custos de Empréstimos PORTUS</h1>
            <p class="mt-2 text-lg text-gray-600">Uma análise interativa dos encargos de empréstimo.</p>
        </header>

        <main>
            <section id="simulator" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">Simulador Interativo de Custos</h2>
                <p class="text-center text-gray-600 mb-8">Ajuste os valores abaixo para entender como os diferentes fatores impactam os custos do seu empréstimo.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    
                    <div class="space-y-6">
                        <div>
                            <label for="netAmountInput" class="block text-sm font-medium text-gray-700">Valor Líquido Desejado: <span id="netAmountLabel" class="font-bold text-blue-600">R$ 50.000</span></label>
                            <input type="range" id="netAmountInput" min="1000" max="100000" step="1000" value="50000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        
                        <div>
                            <label for="loanTerm" class="block text-sm font-medium text-gray-700">Prazo de Amortização</label>
                            <select id="loanTerm" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="0">1 mês</option>
                                <option value="1">6 meses</option>
                                <option value="2" selected>12 meses</option>
                                <option value="3">18 meses</option>
                                <option value="4">24 meses</option>
                                <option value="5">30 meses</option>
                                <option value="6">36 meses</option>
                                <option value="7">42 meses</option>
                                <option value="8">48 meses</option>
                                <option value="9">54 meses</option>
                                <option value="10">60 meses</option>
                            </select>
                        </div>

                        <div>
                            <label for="ageRange" class="block text-sm font-medium text-gray-700">Faixa Etária</label>
                            <select id="ageRange" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="0">Entre 18 e 59 anos</option>
                                <option value="1">Entre 60 e 64 anos</option>
                                <option value="2">Entre 65 e 69 anos</option>
                                <option value="3">Entre 70 e 74 anos</option>
                                <option value="4">Entre 75 e 79 anos</option>
                                <option value="5">Acima de 79 anos</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg text-center border border-blue-200">
                            <p class="text-lg font-medium text-blue-800">Valor Líquido Desejado</p>
                            <p id="summaryNetAmountEl" class="text-3xl md:text-4xl font-bold text-blue-900">R$ 0,00</p>
                        </div>
                        <div class="bg-gray-800 text-white p-4 rounded-lg text-center">
                            <p class="text-lg font-medium text-gray-300">Valor Bruto do Contrato</p>
                            <p id="grossAmountEl" class="text-3xl md:text-4xl font-bold">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <div class="mt-10 border-t pt-8">
                    <h3 class="text-xl font-bold text-center mb-6">Resultados da Simulação</h3>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center md:text-left">Encargos de Originação</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-800">Taxa de Aprovação - TAC <span id="tacPercent" class="font-bold text-blue-900 text-xs"></span></p>
                                <p id="tacValue" class="text-2xl font-bold text-blue-900">R$ 0,00</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="text-sm text-purple-800">Taxa de Risco - QQM <span id="qqmPercent" class="font-bold text-purple-900 text-xs"></span></p>
                                <p id="qqmValue" class="text-2xl font-bold text-purple-900">R$ 0,00</p>
                                <p id="qqmEligibilityMessage" class="text-xs text-red-600 mt-1 hidden">Não Elegível</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <p class="text-sm text-indigo-800">IOF <span id="iofPercent" class="font-bold text-indigo-900 text-xs"></span></p>
                                <p id="iofValue" class="text-2xl font-bold text-indigo-900">R$ 0,00</p>
                            </div>
                             <div class="bg-orange-50 p-4 rounded-lg">
                                <p class="text-sm text-orange-800">Total de Originação</p>
                                <p id="totalOriginationFees" class="text-2xl font-bold text-orange-900">R$ 0,00</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center md:text-left">Encargos de Manutenção (Estimativa Total no Período)</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                            <div class="bg-green-50 p-4 rounded-lg">
                                 <p class="text-sm text-green-800">Total Juros</p>
                                 <p id="totalInterestValue" class="text-2xl font-bold text-green-900">R$ 0,00</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-lg">
                                 <p class="text-sm text-amber-800">Total Correção Monetária</p>
                                 <p id="totalInflationValue" class="text-2xl font-bold text-amber-900">R$ 0,00</p>
                            </div>
                            <div class="bg-cyan-50 p-4 rounded-lg">
                                 <p class="text-sm text-cyan-800">Total Taxa Admin.</p>
                                 <p id="totalAdminFeeValue" class="text-2xl font-bold text-cyan-900">R$ 0,00</p>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <p class="text-sm text-orange-800">Total de Manutenção</p>
                                <p id="totalMaintenanceFees" class="text-2xl font-bold text-orange-900">R$ 0,00</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-10">
                         <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">Composição Detalhada dos Encargos</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div class="chart-container">
                                <canvas id="costsChart"></canvas>
                            </div>
                            <div class="bg-orange-50 p-6 rounded-lg text-center">
                                <p class="text-xl font-medium text-orange-800">Total de Encargos</p>
                                <p id="totalAllFeesValue" class="text-4xl md:text-5xl font-bold text-orange-900">R$ 0,00</p>
                            </div>
                        </div>
                    </div>

                    <div id="financial-indicators-section" class="mt-10 border-t pt-8">
                        <h3 class="text-xl font-bold text-center mb-6">Indicadores Financeiros</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="text-center">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Custo para o Mutuário (CET)</h4>
                                <p class="text-gray-600 mb-4 text-sm">Custo total da operação para quem toma o empréstimo, considerando o valor líquido recebido vs. parcelas pagas.</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <p class="text-sm text-purple-800">CET a.m.</p>
                                        <p id="cetMonthly" class="text-2xl font-bold text-purple-900">0,00%</p>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <p class="text-sm text-purple-800">CET a.a.</p>
                                        <p id="cetAnnual" class="text-2xl font-bold text-purple-900">0,00%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Rentabilidade para o Concessor (TIR)</h4>
                                <p class="text-gray-600 mb-4 text-sm">Retorno da operação, considerando o valor bruto desembolsado vs. as parcelas recebidas (descontada a taxa de adm.).</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-indigo-50 p-4 rounded-lg">
                                        <p class="text-sm text-indigo-800">TIR a.m.</p>
                                        <p id="lenderTirMonthly" class="text-2xl font-bold text-indigo-900">0,00%</p>
                                    </div>
                                    <div class="bg-indigo-50 p-4 rounded-lg">
                                        <p class="text-sm text-indigo-800">TIR a.a.</p>
                                        <p id="lenderTirAnnual" class="text-2xl font-bold text-indigo-900">0,00%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- O restante do HTML permanece inalterado -->
            <section id="details" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg mt-8">
                <h3 class="text-xl font-bold text-center mb-6">Tabela de Amortização Mensal Estimada (Sistema SAC)</h3>
                <p class="text-center text-gray-600 mb-6">Esta tabela detalha a composição de cada parcela mensal, incluindo juros, correção monetária, taxa administrativa, valor amortizado e saldo devedor. </p>
                <div class="table-container rounded-lg shadow-md mb-10">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Parcela</th>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Valor da Parcela</th>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Correção Monetária</th>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Juros</th>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Taxa Administrativa</th>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Valor Amortizado</th>
                                <th class="py-2 px-4 bg-gray-100 text-gray-700 text-sm font-semibold uppercase tracking-wider">Saldo Devedor</th>
                            </tr>
                        </thead>
                        <tbody id="amortizationTableBody">
                        </tbody>
                    </table>
                </div>

                <h2 class="text-2xl font-bold mb-6 text-center">Detalhamento dos Encargos</h2>
                <p class="text-center text-gray-600 mb-8">Abaixo, você encontra uma explicação detalhada de cada componente do custo do seu empréstimo.</p>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex justify-center space-x-4 md:space-x-8" aria-label="Tabs">
                        <button data-tab="origination" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                            Encargos de Originação
                        </button>
                        <button data-tab="maintenance" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                            Encargos de Manutenção
                        </button>
                        <button data-tab="final" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                            Considerações Finais
                        </button>
                    </nav>
                </div>

                <div id="tab-content" class="prose max-w-none">
                    <div id="origination-content" class="tab-pane">
                        <h3 class="font-bold text-lg mb-2">Taxa de Aprovação de Crédito (TAC)</h3>
                        <p class="mb-4">Este encargo financeiro é cobrado no momento da concessão, repactuação ou novação do crédito. Sua finalidade é cobrir os custos administrativos e operacionais associados à análise, aprovação e formalização do Contrato de Empréstimo. O valor corresponde a 0,5% sobre o montante total do contrato. É uma cobrança única, realizada no início da operação.</p>
                        
                        <h3 class="font-bold text-lg mb-2">Taxa de Risco (QQM - Quota de Quitação por Morte)</h3>
                        <p class="mb-4">A Taxa de Risco é um encargo destinado à constituição de um Fundo de Quitação por Morte (FQM), que garante a liquidação integral do saldo devedor do empréstimo em caso de falecimento do mutuário. Este encargo é cobrado em parcela única no momento da concessão do crédito. As alíquotas são variáveis, dependendo da faixa etária do mutuário e do prazo de amortização do empréstimo.</p>

                        <h3 class="font-bold text-lg mb-2">IOF (Imposto sobre Operações Financeiras)</h3>
                        <p>O IOF é um tributo federal incidente sobre operações de crédito. No contexto dos empréstimos da PORTUS, é aplicado sobre o valor total contratado, conforme a legislação vigente. Sua alíquota e metodologia de cálculo são definidas pela Receita Federal do Brasil.</p>
                    </div>
                    <div id="maintenance-content" class="tab-pane hidden">
                        <h3 class="font-bold text-lg mb-2">Taxa de Juros Real</h3>
                        <p class="mb-4">Representa o principal componente de remuneração do capital emprestado. A taxa nominal é de 5,21% ao ano, aplicada mensalmente sobre o saldo devedor. A definição desta taxa considera a Meta Atuarial dos planos de benefícios (INPC + 4,71%), acrescida de 0,48% para cobrir eventuais inadimplências e flutuações de mercado, configurando um custo fixo para o mutuário durante a amortização.</p>

                        <h3 class="font-bold text-lg mb-2">Atualização Monetária</h3>
                        <p class="mb-4">Tem como objetivo preservar o poder de compra do capital emprestado, corrigindo o saldo devedor pela inflação. A PORTUS utiliza o Índice Nacional de Preços ao Consumidor (INPC) como indexador, com uma defasagem de dois meses. Para fins de simulação, é utilizada a meta de inflação de 5% ao ano. A adoção do INPC visa assegurar consistência com a meta atuarial dos planos de benefícios.</p>

                        <h3 class="font-bold text-lg mb-2">Taxa de Administração</h3>
                        <p>Encargo mensal para cobrir os custos operacionais e de gestão do contrato. A taxa é de 5% ao ano e incide sobre o saldo devedor. Sua correta calibração é fundamental para a sustentabilidade da operação de empréstimos.</p>
                    </div>
                    <div id="final-content" class="tab-pane hidden">
                        <p>É de suma importância que os mutuários da PORTUS compreendam integralmente a estrutura da taxa de juros e os encargos incidentes. A transparência na apresentação dessas informações é crucial para que o mutuário possa tomar decisões financeiras conscientes. As taxas e encargos aqui apresentados podem sofrer alterações, em conformidade com o Contrato de Abertura de Crédito e o Regulamento de Empréstimos. Eventuais modificações nas condições serão realizadas a critério da Diretoria Executiva da PORTUS ou em função de alterações na legislação aplicável. Recomenda-se que os mutuários consultem sempre os documentos oficiais da PORTUS e, em caso de dúvidas, busquem esclarecimentos junto aos canais de atendimento da instituição.</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 py-4 border-t">
            <p class="text-sm text-gray-500">&copy; 2025 PORTUS. Todos os direitos reservados.</p>
        </footer>

    </div>

    <script>
        // --- ELEMENT REFERENCES ---
        const netAmountInput = document.getElementById('netAmountInput');
        const netAmountLabel = document.getElementById('netAmountLabel');
        const loanTermSelect = document.getElementById('loanTerm');
        const ageRangeSelect = document.getElementById('ageRange');

        const tacValueEl = document.getElementById('tacValue');
        const qqmValueEl = document.getElementById('qqmValue');
        const iofValueEl = document.getElementById('iofValue');
        const totalOriginationFeesEl = document.getElementById('totalOriginationFees');
        const grossAmountEl = document.getElementById('grossAmountEl');
        const summaryNetAmountEl = document.getElementById('summaryNetAmountEl');
        const totalAllFeesValueEl = document.getElementById('totalAllFeesValue');

        const tacPercentEl = document.getElementById('tacPercent');
        const qqmPercentEl = document.getElementById('qqmPercent');
        const iofPercentEl = document.getElementById('iofPercent');
        const qqmEligibilityMessageEl = document.getElementById('qqmEligibilityMessage'); 

        const totalInterestValueEl = document.getElementById('totalInterestValue');
        const totalInflationValueEl = document.getElementById('totalInflationValue');
        const totalAdminFeeValueEl = document.getElementById('totalAdminFeeValue');
        const totalMaintenanceFeesEl = document.getElementById('totalMaintenanceFees');

        const cetMonthlyEl = document.getElementById('cetMonthly'); 
        const cetAnnualEl = document.getElementById('cetAnnual');   
        const lenderTirMonthlyEl = document.getElementById('lenderTirMonthly');
        const lenderTirAnnualEl = document.getElementById('lenderTirAnnual');

        const amortizationTableBody = document.getElementById('amortizationTableBody');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // --- FORMATTERS ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const formatPercent = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        };

        // --- CONSTANTS AND RATES ---
        const qqmRates = [
            [0.0006909, 0.002947, 0.004919, 0.008315, 0.013507, 0.028696],
            [0.001630, 0.006978, 0.011681, 0.019614, 0.031662, null],
            [0.002204, 0.009466, 0.015874, 0.026524, null, null],
            [0.003176, 0.013719, 0.023043, null, null, null],
            [0.004468, 0.019470, null, null, null, null],
            [0.005797, null, null, null, null, null]
        ];
        const actualMonths = [1, 6, 12, 18, 24, 30, 36, 42, 48, 54, 60]; 
        const tacRate = 0.005; // 0.5%
        const iofRate = 0.0038; // 0.38%
        
        // --- AJUSTE DAS TAXAS MENSAIS ---
        // Calcula a taxa mensal exata para corresponder a 5.21% a.a.
        const monthlyInterestRate = Math.pow(1.0521, 1/12) - 1; 
        // Calcula a taxa mensal exata para corresponder a 5% a.a.
        const monthlyRateFrom5PercentAnnual = Math.pow(1.05, 1/12) - 1;
        const monthlyAdminRate = monthlyRateFrom5PercentAnnual;
        const monthlyINPCRate = monthlyRateFrom5PercentAnnual;
        // --- FIM DO AJUSTE ---

        let costsChart;

        // --- CHART INITIALIZATION ---
        function initializeChart() {
            const ctx = document.getElementById('costsChart').getContext('2d');
            costsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Juros', 'Correção Monetária', 'Taxa Admin.', 'TAC', 'QQM', 'IOF'],
                    datasets: [{
                        label: 'Encargos de Manutenção',
                        data: [0, 0, 0],
                        backgroundColor: ['#a7f3d0', '#fde68a', '#a5f3fc'],
                        borderColor: '#f8f9fa',
                        borderWidth: 2,
                    }, {
                        label: 'Encargos de Originação',
                        data: [0, 0, 0],
                        backgroundColor: ['#dbeafe', '#e9d5ff', '#c7d2fe'],
                        borderColor: '#f8f9fa',
                        borderWidth: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                           display: true,
                           position: 'bottom',
                           labels: {
                               generateLabels: (chart) => {
                                   const allItems = [];
                                   chart.data.datasets.forEach((dataset, i) => {
                                       const meta = chart.getDatasetMeta(i);
                                       const offset = i === 0 ? 0 : 3;
                                       dataset.data.forEach((_, index) => {
                                           allItems.push({
                                               text: chart.data.labels[index + offset],
                                               fillStyle: dataset.backgroundColor[index],
                                               strokeStyle: dataset.backgroundColor[index],
                                               datasetIndex: i,
                                               index: index,
                                               hidden: meta.data[index].hidden
                                           });
                                       });
                                   });
                                   return allItems;
                               }
                           }
                        },
                        tooltip: {
                            // --- AJUSTE DO TOOLTIP ---
                            callbacks: {
                                title: function(tooltipItems) {
                                    // Retorna o rótulo do conjunto de dados (dataset) como o título do tooltip.
                                    if (tooltipItems.length > 0) {
                                        return tooltipItems[0].dataset.label;
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    // Pega o rótulo específico do item, ajustando para os dois anéis.
                                    const offset = context.datasetIndex === 0 ? 0 : 3;
                                    const individualLabel = context.chart.data.labels[context.dataIndex + offset];
                                    
                                    // Formata o valor como moeda.
                                    const value = formatCurrency(context.parsed);

                                    // Retorna o rótulo e o valor para o corpo do tooltip.
                                    return `${individualLabel} (${value})`;
                                }
                            }
                            // --- FIM DO AJUSTE DO TOOLTIP ---
                        }
                    }
                }
            });
        }

        // --- FINANCIAL CALCULATIONS ---
        function calculateIRR(cashFlows, guess) {
            const maxIterations = 1000;
            const precision = 1e-7;
            let irr = guess;
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let derivative = 0;
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + irr, j);
                    derivative -= j * cashFlows[j] / Math.pow(1 + irr, j + 1);
                }
                if (Math.abs(npv) < precision) return irr;
                if (derivative === 0) return irr;
                irr -= npv / derivative;
            }
            return irr;
        }

        function getQqmTermIndex(numMonths) {
            if (numMonths <= 12) return 0;
            if (numMonths <= 18) return 1;
            if (numMonths <= 24) return 2;
            if (numMonths <= 36) return 3;
            if (numMonths <= 48) return 4;
            if (numMonths <= 60) return 5;
            return -1;
        }

        // --- MAIN SIMULATION LOGIC ---
        function updateSimulation() {
            // 1. GET INPUTS
            const desiredNetAmount = parseFloat(netAmountInput.value);
            const termIndex = parseInt(loanTermSelect.value);
            const ageIndex = parseInt(ageRangeSelect.value);
            const numMonths = actualMonths[termIndex];

            netAmountLabel.textContent = formatCurrency(desiredNetAmount);

            // 2. CALCULATE GROSS AMOUNT
            const qqmTermArrayIndex = getQqmTermIndex(numMonths);
            let currentQqmPercent = 0;
            let grossAmount = 0;

            if (qqmTermArrayIndex !== -1 && qqmRates[qqmTermArrayIndex] && qqmRates[qqmTermArrayIndex][ageIndex] !== null) {
                currentQqmPercent = qqmRates[qqmTermArrayIndex][ageIndex];
                qqmEligibilityMessageEl.classList.add('hidden');
            } else {
                currentQqmPercent = 0;
                qqmEligibilityMessageEl.classList.remove('hidden');
            }
            
            const denominator = (1 - tacRate - iofRate) * (1 - currentQqmPercent);
            if (denominator > 0) {
                grossAmount = desiredNetAmount / denominator;
            } else {
                grossAmount = 0;
            }
            
            // 3. CALCULATE ORIGINATION FEES
            const tacValue = grossAmount * tacRate;
            const iofValue = grossAmount * iofRate;
            const baseAmountForQqm = grossAmount - tacValue - iofValue;
            const qqmValue = baseAmountForQqm * currentQqmPercent;
            const totalOriginationFees = tacValue + qqmValue + iofValue;
            
            // 4. UPDATE UI - ORIGINATION AND SUMMARY RESULTS
            grossAmountEl.textContent = formatCurrency(grossAmount);
            summaryNetAmountEl.textContent = formatCurrency(desiredNetAmount);
            tacValueEl.textContent = formatCurrency(tacValue); 
            qqmValueEl.textContent = formatCurrency(qqmValue); 
            iofValueEl.textContent = formatCurrency(iofValue); 
            totalOriginationFeesEl.textContent = formatCurrency(totalOriginationFees); 

            tacPercentEl.textContent = `(${formatPercent(tacRate)})`;
            qqmPercentEl.textContent = `(${formatPercent(currentQqmPercent)})`;
            iofPercentEl.textContent = `(${formatPercent(iofRate)})`;

            // 5. CALCULATE AMORTIZATION TABLE AND MAINTENANCE FEES
            amortizationTableBody.innerHTML = ''; 
            
            let currentSaldoDevedor = grossAmount;
            const constantAmortization = grossAmount <= 0 || numMonths === 0 ? 0 : grossAmount / numMonths; 
            const borrowerCashFlows = [desiredNetAmount]; 
            const lenderCashFlows = [-grossAmount];
            
            let totalJuros = 0;
            let totalCorrecao = 0;
            let totalAdmin = 0;

            for (let i = 1; i <= numMonths; i++) {
                if (currentSaldoDevedor <= 0.01 && i > 1) { 
                    const row = amortizationTableBody.insertRow();
                    for(let j=0; j<7; j++) {
                        row.insertCell().textContent = j === 0 ? i : formatCurrency(0); 
                    }
                    borrowerCashFlows.push(0);
                    lenderCashFlows.push(0);
                    continue; 
                }

                let correcaoMes = currentSaldoDevedor * monthlyINPCRate;
                let saldoDevedorCorrigido = currentSaldoDevedor + correcaoMes; 
                let jurosMes = saldoDevedorCorrigido * monthlyInterestRate;
                let adminMes = saldoDevedorCorrigido * monthlyAdminRate; 
                let custoTotalMes = jurosMes + correcaoMes + adminMes;
                let valorAmortizado = constantAmortization;
                
                if (i === numMonths && currentSaldoDevedor > 0) {
                    valorAmortizado = currentSaldoDevedor;
                    correcaoMes = currentSaldoDevedor * monthlyINPCRate;
                    saldoDevedorCorrigido = currentSaldoDevedor + correcaoMes;
                    jurosMes = saldoDevedorCorrigido * monthlyInterestRate;
                    adminMes = saldoDevedorCorrigido * monthlyAdminRate;
                    custoTotalMes = jurosMes + correcaoMes + adminMes;
                }
                
                let valorParcela = valorAmortizado + custoTotalMes;
                currentSaldoDevedor -= valorAmortizado;
                if (currentSaldoDevedor < 0.01) { currentSaldoDevedor = 0; }
                
                totalJuros += jurosMes;
                totalCorrecao += correcaoMes;
                totalAdmin += adminMes;

                const row = amortizationTableBody.insertRow();
                row.insertCell().textContent = i;
                row.insertCell().textContent = formatCurrency(valorParcela);
                row.insertCell().textContent = formatCurrency(correcaoMes);
                row.insertCell().textContent = formatCurrency(jurosMes);
                row.insertCell().textContent = formatCurrency(adminMes);
                row.insertCell().textContent = formatCurrency(valorAmortizado);
                row.insertCell().textContent = formatCurrency(currentSaldoDevedor);

                borrowerCashFlows.push(-valorParcela);
                lenderCashFlows.push(valorParcela - adminMes);
            }

            // 6. UPDATE UI - MAINTENANCE AND TOTALS
            const totalManutencao = totalJuros + totalCorrecao + totalAdmin;
            const totalAllFees = totalOriginationFees + totalManutencao;
            totalInterestValueEl.textContent = formatCurrency(totalJuros);
            totalInflationValueEl.textContent = formatCurrency(totalCorrecao);
            totalAdminFeeValueEl.textContent = formatCurrency(totalAdmin);
            totalMaintenanceFeesEl.textContent = formatCurrency(totalManutencao);
            totalAllFeesValueEl.textContent = formatCurrency(totalAllFees);
            
            // 7. UPDATE CHART
            updateChartData({
                tac: tacValue,
                qqm: qqmValue,
                iof: iofValue,
                interest: totalJuros,
                inflation: totalCorrecao,
                admin: totalAdmin
            });

            // 8. CALCULATE AND DISPLAY FINANCIAL INDICATORS
            if (numMonths > 0 && grossAmount > 0) {
                // Borrower's CET
                const monthlyCET = calculateIRR(borrowerCashFlows, 0.005);
                const annualCET = Math.pow(1 + monthlyCET, 12) - 1;
                cetMonthlyEl.textContent = formatPercent(monthlyCET);
                cetAnnualEl.textContent = formatPercent(annualCET);
                
                // Lender's TIR
                const monthlyLenderTIR = calculateIRR(lenderCashFlows, 0.005);
                const annualLenderTIR = Math.pow(1 + monthlyLenderTIR, 12) - 1;
                lenderTirMonthlyEl.textContent = formatPercent(monthlyLenderTIR);
                lenderTirAnnualEl.textContent = formatPercent(annualLenderTIR);

            } else {
                cetMonthlyEl.textContent = formatPercent(0);
                cetAnnualEl.textContent = formatPercent(0);
                lenderTirMonthlyEl.textContent = formatPercent(0);
                lenderTirAnnualEl.textContent = formatPercent(0);
            }
        }

        // --- UI HELPERS ---
        function updateChartData(costs) {
            // Outer ring - Maintenance
            costsChart.data.datasets[0].data = [costs.interest, costs.inflation, costs.admin];
            // Inner ring - Origination
            costsChart.data.datasets[1].data = [costs.tac, costs.qqm, costs.iof];
            
            costsChart.update();
        }
        
        function handleTabClick(event) {
            const clickedTab = event.currentTarget;
            const tabName = clickedTab.dataset.tab;
            tabButtons.forEach(button => button.classList.remove('active'));
            clickedTab.classList.add('active');
            tabPanes.forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== `${tabName}-content`);
            });
        }

        // --- EVENT LISTENERS ---
        netAmountInput.addEventListener('input', updateSimulation);
        loanTermSelect.addEventListener('change', updateSimulation);
        ageRangeSelect.addEventListener('change', updateSimulation);
        tabButtons.forEach(button => button.addEventListener('click', handleTabClick));
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart();
            loanTermSelect.value = "2"; // Define 12 meses como padrão ao carregar
            updateSimulation();
            tabButtons[0].click(); // Activate the first tab on load
        });

    </script>
</body>
</html>
